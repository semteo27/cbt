<!-- Created: 2026-01-03 15:30 -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문제 수정 - CBT 시스템</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>문제 수정</h1>
            <nav>
                <a href="{{ url_for('admin') }}" class="btn btn-small">문제 관리</a>
                <a href="{{ url_for('index') }}" class="btn btn-small">홈으로</a>
            </nav>
        </header>

        <main class="form-content">
            <form method="POST" enctype="multipart/form-data" class="question-form">
                <div class="form-group">
                    <label for="question_text">문제 *</label>
                    <textarea id="question_text" name="question_text" rows="4" required>{{ question.question_text }}</textarea>
                </div>

                <div class="form-group">
                    <label for="question_image">문제 이미지</label>
                    {% if question.question_image %}
                        <div class="current-image" id="question-image-preview">
                            <p>현재 이미지:</p>
                            <img src="{{ url_for('static', filename=question.question_image) }}" alt="문제 이미지" style="max-width: 400px;">
                            <button type="button" class="btn-delete-image" onclick="deleteImage({{ question.id }}, 'question')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                </svg>
                                이미지 삭제
                            </button>
                        </div>
                    {% endif %}
                    <input type="file" id="question_image" name="question_image" accept="image/*">
                    <small>새 이미지를 업로드하면 기존 이미지가 교체됩니다 (선택사항)</small>
                </div>

                <div class="option-section">
                    <div class="form-group">
                        <label for="option_a">보기 A *</label>
                        <input type="text" id="option_a" name="option_a" required value="{{ question.option_a }}">
                        {% if question.option_a_image %}
                            <div class="current-image" id="option-a-image-preview">
                                <p>현재 이미지:</p>
                                <img src="{{ url_for('static', filename=question.option_a_image) }}" alt="보기 A 이미지" style="max-width: 200px;">
                                <button type="button" class="btn-delete-image" onclick="deleteImage({{ question.id }}, 'option_a')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                    </svg>
                                    이미지 삭제
                                </button>
                            </div>
                        {% endif %}
                        <label for="option_a_image" class="image-label">보기 A 이미지</label>
                        <input type="file" id="option_a_image" name="option_a_image" accept="image/*">
                    </div>

                    <div class="form-group">
                        <label for="option_b">보기 B *</label>
                        <input type="text" id="option_b" name="option_b" required value="{{ question.option_b }}">
                        {% if question.option_b_image %}
                            <div class="current-image" id="option-b-image-preview">
                                <p>현재 이미지:</p>
                                <img src="{{ url_for('static', filename=question.option_b_image) }}" alt="보기 B 이미지" style="max-width: 200px;">
                                <button type="button" class="btn-delete-image" onclick="deleteImage({{ question.id }}, 'option_b')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                    </svg>
                                    이미지 삭제
                                </button>
                            </div>
                        {% endif %}
                        <label for="option_b_image" class="image-label">보기 B 이미지</label>
                        <input type="file" id="option_b_image" name="option_b_image" accept="image/*">
                    </div>

                    <div class="form-group">
                        <label for="option_c">보기 C *</label>
                        <input type="text" id="option_c" name="option_c" required value="{{ question.option_c }}">
                        {% if question.option_c_image %}
                            <div class="current-image" id="option-c-image-preview">
                                <p>현재 이미지:</p>
                                <img src="{{ url_for('static', filename=question.option_c_image) }}" alt="보기 C 이미지" style="max-width: 200px;">
                                <button type="button" class="btn-delete-image" onclick="deleteImage({{ question.id }}, 'option_c')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                    </svg>
                                    이미지 삭제
                                </button>
                            </div>
                        {% endif %}
                        <label for="option_c_image" class="image-label">보기 C 이미지</label>
                        <input type="file" id="option_c_image" name="option_c_image" accept="image/*">
                    </div>

                    <div class="form-group">
                        <label for="option_d">보기 D *</label>
                        <input type="text" id="option_d" name="option_d" required value="{{ question.option_d }}">
                        {% if question.option_d_image %}
                            <div class="current-image" id="option-d-image-preview">
                                <p>현재 이미지:</p>
                                <img src="{{ url_for('static', filename=question.option_d_image) }}" alt="보기 D 이미지" style="max-width: 200px;">
                                <button type="button" class="btn-delete-image" onclick="deleteImage({{ question.id }}, 'option_d')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                    </svg>
                                    이미지 삭제
                                </button>
                            </div>
                        {% endif %}
                        <label for="option_d_image" class="image-label">보기 D 이미지</label>
                        <input type="file" id="option_d_image" name="option_d_image" accept="image/*">
                    </div>
                </div>

                <div class="form-group">
                    <label for="correct_answer">정답 *</label>
                    <select id="correct_answer" name="correct_answer" required>
                        <option value="A" {% if question.correct_answer == 'A' %}selected{% endif %}>A</option>
                        <option value="B" {% if question.correct_answer == 'B' %}selected{% endif %}>B</option>
                        <option value="C" {% if question.correct_answer == 'C' %}selected{% endif %}>C</option>
                        <option value="D" {% if question.correct_answer == 'D' %}selected{% endif %}>D</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subject_id">과목 *</label>
                    <select id="subject_id" name="subject_id" required>
                        <option value="">과목 선택</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if question.subject_id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                    <small>이 문제가 속할 과목을 선택하세요</small>
                </div>

                <div class="form-group">
                    <label for="exam_set">모의고사 회차 *</label>
                    <select id="exam_set" name="exam_set" required>
                        <option value="1" {% if question.exam_set == 1 %}selected{% endif %}>1회</option>
                        <option value="2" {% if question.exam_set == 2 %}selected{% endif %}>2회</option>
                        <option value="3" {% if question.exam_set == 3 %}selected{% endif %}>3회</option>
                        <option value="4" {% if question.exam_set == 4 %}selected{% endif %}>4회</option>
                        <option value="5" {% if question.exam_set == 5 %}selected{% endif %}>5회</option>
                        <option value="6" {% if question.exam_set == 6 %}selected{% endif %}>6회</option>
                        <option value="7" {% if question.exam_set == 7 %}selected{% endif %}>7회</option>
                        <option value="8" {% if question.exam_set == 8 %}selected{% endif %}>8회</option>
                        <option value="9" {% if question.exam_set == 9 %}selected{% endif %}>9회</option>
                        <option value="10" {% if question.exam_set == 10 %}selected{% endif %}>10회</option>
                        <option value="11" {% if question.exam_set == 11 %}selected{% endif %}>11회</option>
                        <option value="12" {% if question.exam_set == 12 %}selected{% endif %}>12회</option>
                        <option value="13" {% if question.exam_set == 13 %}selected{% endif %}>13회</option>
                        <option value="14" {% if question.exam_set == 14 %}selected{% endif %}>14회</option>
                        <option value="15" {% if question.exam_set == 15 %}selected{% endif %}>15회</option>
                        <option value="16" {% if question.exam_set == 16 %}selected{% endif %}>16회</option>
                        <option value="17" {% if question.exam_set == 17 %}selected{% endif %}>17회</option>
                        <option value="18" {% if question.exam_set == 18 %}selected{% endif %}>18회</option>
                        <option value="19" {% if question.exam_set == 19 %}selected{% endif %}>19회</option>
                        <option value="20" {% if question.exam_set == 20 %}selected{% endif %}>20회</option>
                    </select>
                    <small>이 문제가 속할 모의고사 회차를 선택하세요 (각 회차당 20문제 권장)</small>
                </div>

                <div class="form-group">
                    <label for="explanation">해설</label>
                    <textarea id="explanation" name="explanation" rows="4">{{ question.explanation }}</textarea>
                </div>

                <div class="form-group">
                    <label for="explanation_images">해설 이미지 (최대 5개)</label>
                    {% if question.explanation_images %}
                        {% set images = question.explanation_images.split('|') %}
                        <div class="current-images-grid">
                            <p>현재 이미지 (<span id="current-image-count">{{ images|length }}</span>개 / 최대 5개):</p>
                            {% for img in images %}
                                {% if img %}
                                <div class="current-image" id="explanation-image-{{ loop.index0 }}">
                                    <img src="{{ url_for('static', filename=img) }}" alt="해설 이미지 {{ loop.index }}" style="max-width: 300px;">
                                    <button type="button" class="btn-delete-image" onclick="deleteExplanationImage({{ question.id }}, {{ loop.index0 }})">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                        </svg>
                                        이미지 {{ loop.index }} 삭제
                                    </button>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <script>
                            let currentImageCount = {{ images|length }};
                        </script>
                    {% else %}
                        <script>
                            let currentImageCount = 0;
                        </script>
                    {% endif %}
                    <input type="file" id="explanation_images" name="explanation_images" accept="image/*" multiple>
                    <small>최대 5개까지 추가할 수 있습니다. 새 이미지는 기존 이미지에 추가됩니다. (PNG, JPG, JPEG, GIF, 각 최대 16MB)</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">수정 완료</button>
                    <a href="{{ url_for('admin') }}" class="btn btn-secondary">취소</a>
                </div>
            </form>
        </main>
    </div>

    <script>
        function deleteImage(questionId, imageType) {
            if (!confirm('이미지를 삭제하시겠습니까?')) {
                return;
            }

            fetch(`/admin/delete_image/${questionId}/${imageType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);

                    // 이미지 프리뷰 요소 제거
                    const previewId = imageType === 'question' ? 'question-image-preview' :
                                      imageType === 'explanation' ? 'explanation-image-preview' :
                                      `${imageType}-image-preview`;
                    const previewElement = document.getElementById(previewId);
                    if (previewElement) {
                        previewElement.remove();
                    }
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('이미지 삭제 중 오류가 발생했습니다.');
            });
        }

        function deleteExplanationImage(questionId, imageIndex) {
            if (!confirm('해설 이미지를 삭제하시겠습니까?')) {
                return;
            }

            fetch(`/admin/delete_explanation_image/${questionId}/${imageIndex}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);

                    // 이미지 프리뷰 요소 제거
                    const previewElement = document.getElementById(`explanation-image-${imageIndex}`);
                    if (previewElement) {
                        previewElement.remove();
                    }

                    // 현재 이미지 개수 업데이트
                    currentImageCount--;
                    const countElement = document.getElementById('current-image-count');
                    if (countElement) {
                        countElement.textContent = currentImageCount;
                    }
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('이미지 삭제 중 오류가 발생했습니다.');
            });
        }

        // 해설 이미지 파일 개수 제한 (기존 이미지 + 새 이미지 합쳐서 최대 5개)
        document.getElementById('explanation_images').addEventListener('change', function(e) {
            const files = e.target.files;
            const totalCount = currentImageCount + files.length;

            if (totalCount > 5) {
                alert(`해설 이미지는 최대 5개까지만 추가할 수 있습니다.\n현재: ${currentImageCount}개, 선택: ${files.length}개\n최대 ${5 - currentImageCount}개까지 선택 가능합니다.`);
                e.target.value = ''; // 선택 취소
            }
        });
    </script>
</body>
</html>
